sqs2sf:
  handler: index.starter
  timeout: 200
  memory: 384
  source: '../cumulus/daac-ops-api/dist/'

sns2elasticsearch:
  handler: index.indexer
  timeout: 100
  envs:
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'

log2elasticsearch:
  handler: index.logHandler
  timeout: 100
  memory: 256
  envs:
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  source: '../cumulus/daac-ops-api/dist/'

sf2snsStart:
  handler: index.sfStart
  timeout: 100
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'

sf2snsEnd:
  handler: index.sfEnd
  timeout: 100
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'

ScheduleSF:
  description: 'This lambda function is invoked by scheduled rules created via cumulus API'
  handler: index.scheduler
  timeout: 100
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    ProvidersTable:
      function: Ref
      value: ProvidersTableDynamoDB

jobs:
  handler: index.jobs
  timeout: 300
  memory: 512
  envs:
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  source: '../cumulus/daac-ops-api/dist/'

# used as custom resource for cloudformation manipulation
CustomBootstrap:
  handler: index.bootstrap
  timeout: 100
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    internal: '{{buckets.internal}}'

ApiCollections:
  handler: index.collections
  timeout: 20
  memory: 256
  apiRole: true
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    internal: '{{buckets.internal}}'
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: collections
      method: get
      cors: true
      api: backend
    - path: collections/{collectionName}/{version}
      method: get
      cors: true
      api: backend
    - path: collections
      method: post
      cors: true
      api: backend
    - path: collections/{collectionName}/{version}
      method: put
      cors: true
      api: backend
    - path: collections/{collectionName}/{version}
      method: delete
      cors: true
      api: backend

ApiGranules:
  handler: index.granules
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  apiRole: true
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    ProvidersTable:
      function: Ref
      value: ProvidersTableDynamoDB
    invoke:
      function: "Ref"
      value: ScheduleSFLambdaFunction
    bucket: '{{buckets.internal}}'
    internal: '{{buckets.internal}}'
    cmr_provider: '{{cmr.provider}}'
    cmr_client_id: '{{cmr.clientId}}'
    cmr_username: '{{cmr.username}}'
    cmr_password: 
      function: "Fn::GetAtt"
      array:
        - CumulusCustomResource
        - CmrPassword
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: granules
      method: get
      cors: true
      api: backend
    - path: granules/{granuleName}
      method: get
      cors: true
      api: backend
    - path: granules/{granuleName}
      method: put
      cors: true
      api: backend
    - path: granules/{granuleName}
      method: delete
      cors: true
      api: backend

ApiExecutions:
  handler: index.executions
  timeout: 20
  memory: 256
  apiRole: true
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: executions
      method: get
      cors: true
      api: backend
    - path: executions/{arn}
      method: get
      cors: true
      api: backend
  
ApiExecutionStatus:
  handler: index.executionStatus
  timeout: 20
  memory: 256
  apiRole: true
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: executions/status/{arn}
      method: get
      cors: true
      api: backend

ApiWorkflows:
  handler: index.workflows
  timeout: 20
  memory: 256
  apiRole: true
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    bucket: '{{buckets.internal}}'
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
  apiGateway:
    - path: workflows
      method: get
      cors: true
      api: backend
    - path: workflows/{name}
      method: get
      cors: true
      api: backend

ApiRules:
  handler: index.rules
  timeout: 20
  memory: 256
  apiRole: true
  envs:
    bucket: '{{buckets.internal}}'
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    ProvidersTable:
      function: Ref
      value: ProvidersTableDynamoDB
    RulesTable:
      function: Ref
      value: RulesTableDynamoDB
    invoke:
      function: "Ref"
      value: ScheduleSFLambdaFunction
    invokeArn:
      function: "Fn::GetAtt"
      array:
        - ScheduleSFLambdaFunction
        - Arn
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  source: '../cumulus/daac-ops-api/dist/'
  apiGateway:
    - path: rules
      method: get
      cors: true
      api: backend
    - path: rules/{name}
      method: get
      cors: true
      api: backend
    - path: rules
      method: post
      cors: true
      api: backend
    - path: rules/{name}
      method: put
      cors: true
      api: backend
    - path: rules/{name}
      method: delete
      cors: true
      api: backend

ApiProviders:
  handler: index.providers
  timeout: 20
  memory: 256
  apiRole: true
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    ProvidersTable:
      function: Ref
      value: ProvidersTableDynamoDB
    internal: '{{buckets.internal}}'
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  source: '../cumulus/daac-ops-api/dist/'
  apiGateway:
    - path: providers
      method: get
      cors: true
      api: backend
    - path: providers/{id}
      method: get
      cors: true
      api: backend
    - path: providers
      method: post
      cors: true
      api: backend
    - path: providers/{id}
      method: put
      cors: true
      api: backend
    - path: providers/{id}
      method: delete
      cors: true
      api: backend

ApiPdrs:
  handler: index.pdrs
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    internal: '{{buckets.internal}}'
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: pdrs
      method: get
      cors: true
      api: backend
    - path: pdrs/{pdrName}
      method: get
      cors: true
      api: backend
    - path: pdrs/{pdrName}
      method: delete
      cors: true
      api: backend

ApiLogs:
  handler: index.logs
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  apiRole: true
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: stats/logs
      method: get
      cors: true
      api: backend
    - path: logs
      method: get
      cors: true
      api: backend

ApiSchema:
  handler: index.schemas
  timeout: 20
  memory: 256
  apiRole: true
  source: '../cumulus/daac-ops-api/dist/'
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
  apiGateway:
    - path: schemas/{schemaName}
      method: get
      cors: true
      api: backend

ApiStats:
  handler: index.stats
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  apiRole: true
  envs:
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    ES_HOST:
      function: "Fn::GetAtt"
      array:
        - '{{es.name}}Domain'
        - DomainEndpoint
  apiGateway:
    - path: stats
      method: get
      cors: true
      api: backend
    - path: stats/histogram
      method: get
      cors: true
      api: backend
    - path: stats/aggregate
      method: get
      cors: true
      api: backend
    - path: stats/average
      method: get
      cors: true
      api: backend

ApiToken:
  handler: index.token
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  apiRole: true
  urs: true
  envs:
    EARTHDATA_BASE_URL: '{{urs_url}}'
    EARTHDATA_CLIENT_ID: '{{EARTHDATA_CLIENT_ID}}'
    EARTHDATA_CLIENT_PASSWORD: '{{EARTHDATA_CLIENT_PASSWORD}}'
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
  apiGateway:
    - api: backend
      path: token
      method: get
      cors: true

ApiDistribution:
  handler: index.distribution
  timeout: 20
  memory: 256
  source: '../cumulus/daac-ops-api/dist/'
  apiRole: true
  urs: true
  envs:
    EARTHDATA_BASE_URL: '{{urs_url}}' 
    EARTHDATA_CLIENT_ID: '{{EARTHDATA_CLIENT_ID}}'
    EARTHDATA_CLIENT_PASSWORD: '{{EARTHDATA_CLIENT_PASSWORD}}'
    protected: '{{buckets.protected}}'
  apiGateway:
    - api: distribution
      path: 'redirect'
      method: get
    - api: distribution
      path: '{granuleId}'
      method: get
